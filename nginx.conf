# Refoodify Load Balancer Configuration
# Configure nginx on Lb01 to distribute traffic across Web01 and Web02
# This uses round-robin load balancing by default

# Upstream servers (Web01 and Web02)
upstream refoodify_backend {
    # Round-robin distribution (default)
    # Uncomment specific lines for different load balancing methods:
    
    # Standard round-robin (requests alternate between servers)
    server 192.168.1.101:3000 max_fails=3 fail_timeout=30s;
    server 192.168.1.102:3000 max_fails=3 fail_timeout=30s;
    
    # For least connections method, add: least_conn;
    # For IP hash (sticky sessions), add: ip_hash;
    
    # Health check parameters:
    # max_fails=3 : Mark server down after 3 failed attempts
    # fail_timeout=30s : Recovery attempt after 30 seconds
    
    keepalive 32;
}

# HTTP redirect to HTTPS (optional - remove if not using SSL)
server {
    listen 80;
    listen [::]:80;
    server_name _;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$host$request_uri;
}

# Main server configuration
server {
    listen 80;
    listen [::]:80;
    
    # Replace with your domain or keep as IP
    server_name lb01.refoodify.local;
    
    # Logging
    access_log /var/log/nginx/refoodify_access.log;
    error_log /var/log/nginx/refoodify_error.log;
    
    # Load balancer endpoint
    location / {
        # Proxy settings
        proxy_pass http://refoodify_backend;
        proxy_http_version 1.1;
        
        # Headers for proper proxying
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # API endpoints (optional - if different routing needed)
    location /api/ {
        proxy_pass http://refoodify_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }
    
    # Static files (optional - can cache on LB)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://refoodify_backend;
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status "HIT from LB";
    }
    
    # Health check endpoint (for monitoring)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# Upstream configuration notes:
# ================================
# 1. ROUND-ROBIN (default):
#    - Requests alternate: Web01, Web02, Web01, Web02, ...
#    - Best for balanced workloads
#    - No configuration needed (default behavior)
#
# 2. LEAST CONNECTIONS:
#    - Uncomment: least_conn;
#    - Requests go to server with fewest active connections
#    - Good for long-lived connections
#
# 3. IP HASH:
#    - Uncomment: ip_hash;
#    - Same client IP always routes to same backend
#    - Good for session persistence
#
# 4. WEIGHTED ROUND-ROBIN:
#    - Replace servers with: server 192.168.1.101:3000 weight=5;
#    - Distributes based on weight ratio
#
# Update server IPs (192.168.1.101, 192.168.1.102) 
# to match your actual Web01 and Web02 private IPs in Oracle Cloud
